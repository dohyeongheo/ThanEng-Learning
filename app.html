<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BKK HUSTLER: REAL DATA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Sarabun:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f2f4f6;
            --bg-secondary: #ffffff;
            --text-primary: #191f28;
            --text-secondary: #8b95a1;
            --border-color: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .thai-font {
            font-family: 'Sarabun', sans-serif;
        }

        .card-press {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }

        .card-press:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .card-press:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .card-press:active {
            transform: scale(0.98);
            transition: 0.1s;
        }

        [data-theme="dark"] .card-press:active {
            background-color: #3a3a3a;
        }

        /* í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        #view-list,
        #view-detail {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ì¹´ë“œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        .card-enter {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ê°œì„  */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        html {
            scroll-behavior: smooth;
        }

        .tab-active {
            background-color: var(--bg-secondary);
            color: #3182f6;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .tab-active {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .tab-inactive {
            color: var(--text-secondary);
            background-color: transparent;
        }

        /* ë‹¤í¬ ëª¨ë“œ ì „ì—­ ìŠ¤íƒ€ì¼ */
        [data-theme="dark"] .bg-white {
            background-color: var(--bg-secondary) !important;
        }

        [data-theme="dark"] .bg-\\[\\#f2f4f6\\] {
            background-color: var(--bg-primary) !important;
        }

        [data-theme="dark"] .text-gray-500,
        [data-theme="dark"] .text-gray-400 {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .text-\\[\\#333\\] {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .text-\\[\\#8b95a1\\] {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .border-gray-100,
        [data-theme="dark"] .border-gray-200 {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .bg-gray-100 {
            background-color: #404040 !important;
        }

        [data-theme="dark"] .bg-gray-200 {
            background-color: #505050 !important;
        }

        [data-theme="dark"] .hover\\:bg-gray-100:hover {
            background-color: #404040 !important;
        }

        [data-theme="dark"] input,
        [data-theme="dark"] textarea {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] input::placeholder {
            color: var(--text-secondary);
        }
    </style>
</head>

<body class="h-screen flex flex-col max-w-md mx-auto overflow-hidden" style="background-color: var(--bg-primary);">

    <!-- VIEW 1: DAY LIST -->
    <div id="view-list" class="flex flex-col h-full" style="background-color: var(--bg-primary);">
        <div class="px-6 pt-12 pb-4 sticky top-0 z-10 rounded-b-3xl shadow-sm" style="background-color: var(--bg-secondary);">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h1 class="text-2xl font-black mb-1">ë°©ì½• ìƒì¡´ ì™„ì„± ğŸ”¥</h1>
                    <p class="text-[#8b95a1] text-sm">íƒœêµ­ì–´ & ì˜ì–´ í•™ìŠµ ì•±</p>
                </div>
                <button id="theme-toggle" onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">
                    <i id="theme-icon" class="fas fa-moon text-xl text-gray-600"></i>
                </button>
            </div>
            <!-- ê²€ìƒ‰ ì…ë ¥ì°½ -->
            <div class="mt-4 relative">
                <input type="text" id="search-input" placeholder="íƒœêµ­ì–´, í•œê¸€ ë°œìŒ, í•œêµ­ì–´ ì˜ë¯¸ë¡œ ê²€ìƒ‰..."
                    class="w-full px-4 py-2 pl-10 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#3182f6] focus:border-transparent"
                    aria-label="ê²€ìƒ‰ ì…ë ¥">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" aria-hidden="true"></i>
                <button id="search-clear" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden" aria-label="ê²€ìƒ‰ ì§€ìš°ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="list-container">
            <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <i class="fas fa-spinner spinner text-4xl text-[#3182f6] mb-4"></i>
                        <p class="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
            </div>
        </div>
    </div>

    <!-- VIEW 2: DETAIL -->
    <div id="view-detail" class="hidden flex-col h-full" style="background-color: var(--bg-secondary);">
        <!-- Header -->
        <div class="px-4 py-3 border-b flex items-center justify-between sticky top-0 z-20" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
            <button onclick="goBack()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="ë’¤ë¡œê°€ê¸°"><i
                    class="fas fa-arrow-left text-xl" aria-hidden="true"></i></button>
            <span class="font-bold text-lg" id="header-title">DAY 1</span>
            <button id="theme-toggle-detail" onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">
                <i id="theme-icon-detail" class="fas fa-moon text-xl text-gray-600"></i>
            </button>
        </div>

        <!-- Tabs -->
        <div class="px-4 py-3 z-10" style="background-color: var(--bg-secondary);">
            <div class="p-1 rounded-xl flex text-sm" style="background-color: var(--bg-primary);">
                <button onclick="setTab('th')" id="btn-th" class="flex-1 py-3 rounded-lg tab-active"
                    aria-label="íƒœêµ­ì–´ íƒ­">íƒœêµ­ì–´ (<span id="count-th">0</span>)</button>
                <button onclick="setTab('en')" id="btn-en" class="flex-1 py-3 rounded-lg tab-inactive"
                    aria-label="ì˜ì–´ íƒ­">ì˜ì–´ (<span id="count-en">0</span>)</button>
                <button onclick="setTab('favorite')" id="btn-favorite" class="flex-1 py-3 rounded-lg tab-inactive"
                    aria-label="ì¦ê²¨ì°¾ê¸° íƒ­">ì¦ê²¨ì°¾ê¸° (<span id="count-favorite">0</span>)</button>
                <button onclick="setTab('quiz')" id="btn-quiz" class="flex-1 py-3 rounded-lg tab-inactive"
                    aria-label="í€´ì¦ˆ íƒ­">í€´ì¦ˆ (TEST)</button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-10" id="content-area" role="tabpanel" aria-live="polite" aria-atomic="true"></div>
    </div>

    <script>
        // ============================================================
        // 0. UTILITY FUNCTIONS
        // ============================================================
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€)
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================================
        // 1. DATA LOADING (from data.json)
        // ============================================================
        let DB = {}; // ë°ì´í„°ë² ì´ìŠ¤ ê°ì²´ (ë™ì ìœ¼ë¡œ ë¡œë“œë¨)

        // Storage Manager
        const StorageManager = {
            CACHE_KEY: 'thaieng_data_cache',
            ETAG_KEY: 'thaieng_data_etag',
            TIMESTAMP_KEY: 'thaieng_data_timestamp',
            CACHE_DURATION: 24 * 60 * 60 * 1000, // 24ì‹œê°„
            FAVORITE_KEY: 'thaieng_favorites',

            getCachedData() {
                try {
                    const cached = localStorage.getItem(this.CACHE_KEY);
                    const timestamp = localStorage.getItem(this.TIMESTAMP_KEY);
                    if (cached && timestamp) {
                        const age = Date.now() - parseInt(timestamp);
                        if (age < this.CACHE_DURATION) {
                            return JSON.parse(cached);
                        }
                    }
                } catch (e) {
                    console.warn('ìºì‹œ ì½ê¸° ì‹¤íŒ¨:', e);
                }
                return null;
            },

            setCachedData(data, etag) {
                try {
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(this.ETAG_KEY, etag || '');
                    localStorage.setItem(this.TIMESTAMP_KEY, Date.now().toString());
                } catch (e) {
                    console.warn('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e);
                    // localStorageê°€ ê°€ë“ ì°¬ ê²½ìš° ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ ì‹œë„
                    if (e.name === 'QuotaExceededError') {
                        this.clearCache();
                    }
                }
            },

            getEtag() {
                return localStorage.getItem(this.ETAG_KEY) || null;
            },

            clearCache() {
                localStorage.removeItem(this.CACHE_KEY);
                localStorage.removeItem(this.ETAG_KEY);
                localStorage.removeItem(this.TIMESTAMP_KEY);
            },

            // ì¦ê²¨ì°¾ê¸° ê´€ë¦¬
            getFavorites() {
                try {
                    const favorites = localStorage.getItem(this.FAVORITE_KEY);
                    return favorites ? JSON.parse(favorites) : [];
                } catch (e) {
                    console.warn('ì¦ê²¨ì°¾ê¸° ì½ê¸° ì‹¤íŒ¨:', e);
                    return [];
                }
            },

            addFavorite(day, lang, index) {
                try {
                    const favorites = this.getFavorites();
                    const key = `${day}_${lang}_${index}`;
                    if (!favorites.includes(key)) {
                        favorites.push(key);
                        localStorage.setItem(this.FAVORITE_KEY, JSON.stringify(favorites));
                    }
                } catch (e) {
                    console.warn('ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì‹¤íŒ¨:', e);
                }
            },

            removeFavorite(day, lang, index) {
                try {
                    const favorites = this.getFavorites();
                    const key = `${day}_${lang}_${index}`;
                    const indexToRemove = favorites.indexOf(key);
                    if (indexToRemove > -1) {
                        favorites.splice(indexToRemove, 1);
                        localStorage.setItem(this.FAVORITE_KEY, JSON.stringify(favorites));
                    }
                } catch (e) {
                    console.warn('ì¦ê²¨ì°¾ê¸° ì œê±° ì‹¤íŒ¨:', e);
                }
            },

            isFavorite(day, lang, index) {
                const favorites = this.getFavorites();
                const key = `${day}_${lang}_${index}`;
                return favorites.includes(key);
            }
        };

        // data.json íŒŒì¼ ë¡œë“œ (ìºì‹± ì§€ì›)
        async function loadData() {
            const container = document.getElementById('list-container');

            // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ
            const cachedData = StorageManager.getCachedData();
            if (cachedData) {
                DB = cachedData;
                normalizeDB();
                renderList();
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì—…ë°ì´íŠ¸ í™•ì¸
                updateDataInBackground();
                return;
            }

            // ìºì‹œê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ë¡œë“œ
            try {
                updateLoadingProgress(0);
                const etag = StorageManager.getEtag();
                const headers = {};
                if (etag) {
                    headers['If-None-Match'] = etag;
                }

                const response = await fetch('data.json', { headers });
                updateLoadingProgress(50);

                if (response.status === 304) {
                    // Not Modified - ìºì‹œ ì‚¬ìš©
                    const cached = StorageManager.getCachedData();
                    if (cached) {
                        DB = cached;
                        normalizeDB();
                        renderList();
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updateLoadingProgress(80);

                DB = data;
                normalizeDB();

                // ETag ì €ì¥
                const newEtag = response.headers.get('ETag') || response.headers.get('etag');
                StorageManager.setCachedData(data, newEtag);

                updateLoadingProgress(100);
                renderList();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                const cached = StorageManager.getCachedData();
                if (cached) {
                    DB = cached;
                    normalizeDB();
                    renderList();
                    showWarning('ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                } else {
                    showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë°ì´í„° ì—…ë°ì´íŠ¸ í™•ì¸
        async function updateDataInBackground() {
            try {
                const etag = StorageManager.getEtag();
                const headers = {};
                if (etag) {
                    headers['If-None-Match'] = etag;
                }

                const response = await fetch('data.json', { headers });

                if (response.status === 304) {
                    // ë°ì´í„° ë³€ê²½ ì—†ìŒ
                    return;
                }

                if (response.ok) {
                    const data = await response.json();
                    const newEtag = response.headers.get('ETag') || response.headers.get('etag');
                    StorageManager.setCachedData(data, newEtag);

                    // ë°ì´í„° ì—…ë°ì´íŠ¸
                    DB = data;
                    normalizeDB();
                    renderList();
                }
            } catch (error) {
                // ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
                console.debug('ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // DB ì •ê·œí™” (í‚¤ë¥¼ ìˆ«ìë¡œ ë³€í™˜)
        function normalizeDB() {
            const normalizedDB = {};
            for (const [key, value] of Object.entries(DB)) {
                normalizedDB[parseInt(key)] = value;
            }
            DB = normalizedDB;
        }

        // ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateLoadingProgress(percent) {
            const container = document.getElementById('list-container');
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <i class="fas fa-spinner spinner text-4xl text-[#3182f6] mb-4"></i>
                            <p class="text-gray-500 mb-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            <div class="w-64 bg-gray-200 rounded-full h-2">
                                <div class="bg-[#3182f6] h-2 rounded-full transition-all duration-300" style="width: ${percent}%"></div>
                            </div>
                            <p class="text-gray-400 text-sm mt-2">${percent}%</p>
                        </div>
                    </div>
                `;
            }
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const container = document.getElementById('list-container');
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 p-6 rounded-2xl text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                    <p class="text-red-700 font-bold mb-2">ì˜¤ë¥˜ ë°œìƒ</p>
                    <p class="text-red-600 text-sm">${escapeHtml(message)}</p>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            `;
        }

        // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
        function showWarning(message) {
            const container = document.getElementById('list-container');
            const existingWarning = container.querySelector('.warning-message');
            if (existingWarning) {
                existingWarning.remove();
            }

            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-message bg-yellow-50 border border-yellow-200 p-3 rounded-xl text-center mb-3';
            warningDiv.innerHTML = `
                <p class="text-yellow-700 text-sm">
                    <i class="fas fa-info-circle mr-2"></i>${escapeHtml(message)}
                </p>
            `;
            container.insertBefore(warningDiv, container.firstChild);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.remove();
                }
            }, 5000);
        }

        // ============================================================
        // 2. LOGIC (Quiz Generator & UI)
        // ============================================================
        let currentDay = 1;
        let currentTab = 'th';
        let voices = [];
        let quizAnswered = false; // í€´ì¦ˆ ë‹µë³€ ìƒíƒœ ì¶”ì 
        let scrollPositions = {}; // íƒ­ë³„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
        let quizLangToggle = true; // true = íƒœêµ­ì–´, false = ì˜ì–´ (ë²ˆê°ˆì•„ê°€ë©°)

        window.onload = function () {
            // ë°ì´í„° ë¡œë“œ
            loadData();

            // Audio Init
            const loadVoices = () => {
                if (window.speechSynthesis) {
                    voices = window.speechSynthesis.getVoices();
                }
            };
            loadVoices();
            if (window.speechSynthesis && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }

            // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
            window.addEventListener('popstate', function (event) {
                if (document.getElementById('view-detail').classList.contains('flex')) {
                    goBack();
                }
            });

            // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initSearch();

            // ë‹¤í¬ ëª¨ë“œ ì´ˆê¸°í™”
            initTheme();

            // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initKeyboardNavigation();
        };

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
        function initKeyboardNavigation() {
            // Enter í‚¤ë¡œ ì¹´ë“œ í´ë¦­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.hasAttribute('role') && e.target.getAttribute('role') === 'button') {
                    e.target.click();
                }

                // ESC í‚¤ë¡œ ë’¤ë¡œê°€ê¸°
                if (e.key === 'Escape' && document.getElementById('view-detail').classList.contains('flex')) {
                    goBack();
                }

                // Tab í‚¤ë¡œ í¬ì»¤ìŠ¤ ê´€ë¦¬
                if (e.key === 'Tab') {
                    const focusableElements = document.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }

                // í™”ì‚´í‘œ í‚¤ë¡œ íƒ­ ì „í™˜
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const tabs = ['th', 'en', 'favorite', 'quiz'];
                    const currentIndex = tabs.indexOf(currentTab);
                    if (currentIndex !== -1) {
                        if (e.key === 'ArrowLeft' && currentIndex > 0) {
                            e.preventDefault();
                            setTab(tabs[currentIndex - 1]);
                        } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
                            e.preventDefault();
                            setTab(tabs[currentIndex + 1]);
                        }
                    }
                }
            });

            // í¬ì»¤ìŠ¤ íŠ¸ë© (ëª¨ë‹¬ì´ë‚˜ ìƒì„¸ í™”ë©´ì—ì„œ)
            function trapFocus(element) {
                const focusableElements = element.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        if (e.shiftKey && document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        } else if (!e.shiftKey && document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                });
            }

            // ìƒì„¸ í™”ë©´ì— í¬ì»¤ìŠ¤ íŠ¸ë© ì ìš©
            const detailView = document.getElementById('view-detail');
            if (detailView) {
                trapFocus(detailView);
            }
        }

        // ë‹¤í¬ ëª¨ë“œ ì´ˆê¸°í™”
        function initTheme() {
            const savedTheme = localStorage.getItem('thaieng_theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            applyTheme(theme);
        }

        // í…Œë§ˆ ì ìš©
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('theme-icon');
            const iconDetail = document.getElementById('theme-icon-detail');

            if (theme === 'dark') {
                if (icon) icon.className = 'fas fa-sun text-xl text-yellow-400';
                if (iconDetail) iconDetail.className = 'fas fa-sun text-xl text-yellow-400';
            } else {
                if (icon) icon.className = 'fas fa-moon text-xl text-gray-600';
                if (iconDetail) iconDetail.className = 'fas fa-moon text-xl text-gray-600';
            }

            localStorage.setItem('thaieng_theme', theme);
        }

        // í…Œë§ˆ í† ê¸€
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        // ì‹œìŠ¤í…œ í…Œë§ˆ ë³€ê²½ ê°ì§€
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem('thaieng_theme');
            if (!savedTheme) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchClear = document.getElementById('search-clear');

            if (!searchInput) return;

            // ì‹¤ì‹œê°„ ê²€ìƒ‰
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                if (query.length > 0) {
                    searchClear.classList.remove('hidden');
                    performSearch(query);
                } else {
                    searchClear.classList.add('hidden');
                    renderList();
                }
            });

            // ê²€ìƒ‰ ì§€ìš°ê¸°
            if (searchClear) {
                searchClear.addEventListener('click', function() {
                    searchInput.value = '';
                    searchClear.classList.add('hidden');
                    renderList();
                    searchInput.focus();
                });
            }

            // ESC í‚¤ë¡œ ê²€ìƒ‰ ì·¨ì†Œ
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    searchClear.classList.add('hidden');
                    renderList();
                }
            });
        }

        // ê²€ìƒ‰ ìˆ˜í–‰
        function performSearch(query) {
            if (!query || query.length === 0) {
                renderList();
                return;
            }

            const container = document.getElementById('list-container');
            const lowerQuery = query.toLowerCase();
            const results = [];

            // ëª¨ë“  Dayì™€ ë‹¨ì–´ ê²€ìƒ‰
            for (const [day, data] of Object.entries(DB)) {
                const dayResults = {
                    day: parseInt(day),
                    topic: data.topic,
                    items: []
                };

                // íƒœêµ­ì–´ ê²€ìƒ‰
                if (data.th) {
                    data.th.forEach((item, i) => {
                        if (!item || !item.t) return;
                        const matches =
                            item.t.toLowerCase().includes(lowerQuery) ||
                            (item.k && item.k.toLowerCase().includes(lowerQuery)) ||
                            (item.m && item.m.toLowerCase().includes(lowerQuery));

                        if (matches) {
                            dayResults.items.push({
                                type: 'th',
                                index: i,
                                item: item
                            });
                        }
                    });
                }

                // ì˜ì–´ ê²€ìƒ‰
                if (data.en) {
                    data.en.forEach((item, i) => {
                        if (!item || !item.t) return;
                        const matches =
                            item.t.toLowerCase().includes(lowerQuery) ||
                            (item.m && item.m.toLowerCase().includes(lowerQuery));

                        if (matches) {
                            dayResults.items.push({
                                type: 'en',
                                index: i,
                                item: item
                            });
                        }
                    });
                }

                if (dayResults.items.length > 0) {
                    results.push(dayResults);
                }
            }

            // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
            renderSearchResults(results, query);
        }

        // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
        function renderSearchResults(results, query) {
            const container = document.getElementById('list-container');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <p class="text-gray-400 text-sm mt-2">"${escapeHtml(query)}"</p>
                        </div>
                    </div>
                `;
                return;
            }

            let html = `<div class="mb-4 text-sm text-gray-500">ê²€ìƒ‰ ê²°ê³¼: <span class="font-bold text-[#3182f6]">${results.length}ê°œ Day</span>, ì´ <span class="font-bold text-[#3182f6]">${results.reduce((sum, r) => sum + r.items.length, 0)}ê°œ</span> ë‹¨ì–´</div>`;

            results.forEach(result => {
                html += `
                <div class="mb-6">
                    <div class="bg-white p-4 rounded-2xl mb-3 border border-blue-100">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <span class="text-[#3182f6] text-xs font-bold">DAY ${result.day}</span>
                                <h3 class="text-base font-bold text-[#333] mt-1">${escapeHtml(result.topic)}</h3>
                            </div>
                            <button onclick="openDay(${result.day})" class="text-[#3182f6] text-sm font-bold hover:underline" aria-label="DAY ${result.day} ë³´ê¸°">
                                ë³´ê¸° <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                `;

                result.items.forEach(({ type, index, item }) => {
                    if (type === 'th') {
                        const escapedT = escapeHtml(item.t);
                        const escapedK = escapeHtml(item.k || '');
                        const escapedM = escapeHtml(item.m || '');
                        html += `
                        <div onclick="openDay(${result.day}); setTimeout(() => setTab('th'), 100);" class="bg-white p-4 rounded-xl border border-gray-100 card-press cursor-pointer hover:border-blue-200" role="button" tabindex="0">
                            <div class="flex items-start justify-between mb-1">
                                <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">íƒœêµ­ì–´ #${index + 1}</span>
                                <i class="fas fa-volume-high text-gray-300 text-sm" aria-hidden="true"></i>
                            </div>
                            <h4 class="text-lg font-bold text-[#333] mb-1 thai-font">${highlightText(escapedT, query)}</h4>
                            <p class="text-sm text-[#ef4444] font-bold mb-1">${highlightText(escapedK, query)}</p>
                            <p class="text-sm text-gray-500">${highlightText(escapedM, query)}</p>
                        </div>
                        `;
                    } else {
                        const escapedT = escapeHtml(item.t);
                        const escapedM = escapeHtml(item.m || '');
                        html += `
                        <div onclick="openDay(${result.day}); setTimeout(() => setTab('en'), 100);" class="bg-white p-4 rounded-xl border border-gray-100 card-press cursor-pointer hover:border-blue-200" role="button" tabindex="0">
                            <div class="flex items-start justify-between mb-1">
                                <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">ì˜ì–´ #${index + 1}</span>
                                <i class="fas fa-volume-high text-gray-300 text-sm" aria-hidden="true"></i>
                            </div>
                            <h4 class="text-base font-bold text-[#333] mb-1 italic">"${highlightText(escapedT, query)}"</h4>
                            <p class="text-sm text-gray-500">${highlightText(escapedM, query)}</p>
                        </div>
                        `;
                    }
                });

                html += `</div></div>`;
            });

            container.innerHTML = html;
        }

        // í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightText(text, query) {
            if (!query || query.length === 0) return text;
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
        }

        // ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function renderList() {
            const container = document.getElementById('list-container');
            let html = '';
            let delay = 0;
            for (const [day, data] of Object.entries(DB)) {
                html += `
                <div onclick="openDay(${day})" class="bg-white p-5 rounded-2xl flex justify-between items-center card-press cursor-pointer border border-transparent hover:border-blue-100 shadow-sm card-enter" role="button" tabindex="0" aria-label="DAY ${day}: ${escapeHtml(data.topic)}" style="animation-delay: ${delay * 0.05}s;">
                    <div>
                        <span class="text-[#3182f6] text-xs font-bold block mb-1">DAY ${day}</span>
                        <h3 class="text-lg font-bold text-[#333]">${escapeHtml(data.topic)}</h3>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300" aria-hidden="true"></i>
                </div>`;
                delay++;
            }
            container.innerHTML = html;
        }

        function openDay(day) {
            // ë°ì´í„° ê²€ì¦
            if (!DB[day]) {
                console.error(`Day ${day} ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            currentDay = day;
            quizAnswered = false; // í€´ì¦ˆ ìƒíƒœ ì´ˆê¸°í™”
            scrollPositions = {}; // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
            quizLangToggle = true; // í€´ì¦ˆ ì–¸ì–´ í† ê¸€ ì´ˆê¸°í™” (íƒœêµ­ì–´ë¶€í„° ì‹œì‘)

            document.getElementById('view-list').classList.add('hidden');
            const detailView = document.getElementById('view-detail');
            detailView.classList.remove('hidden');
            detailView.classList.add('flex');
            // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
            setTimeout(() => {
                detailView.style.animation = 'none';
                setTimeout(() => {
                    detailView.style.animation = '';
                }, 10);
            }, 0);

            const topic = DB[day].topic.split('(')[0].trim();
            document.getElementById('header-title').textContent = `DAY ${day}: ${topic}`;

            // íƒ­ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            updateTabCounts();
            setTab('th');

            // íˆìŠ¤í† ë¦¬ ê´€ë¦¬ (ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì§€ì›)
            if (window.history && window.history.pushState) {
                window.history.pushState({ view: 'detail', day: day }, '', `#day-${day}`);
            }
        }

        function updateTabCounts() {
            const data = DB[currentDay];
            if (data) {
                const thCount = data.th ? data.th.length : 0;
                const enCount = data.en ? data.en.length : 0;
                document.getElementById('count-th').textContent = thCount;
                document.getElementById('count-en').textContent = enCount;

                // ì¦ê²¨ì°¾ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
                const favorites = StorageManager.getFavorites();
                document.getElementById('count-favorite').textContent = favorites.length;
            }
        }

        // ì¦ê²¨ì°¾ê¸° í† ê¸€
        function toggleFavorite(day, lang, index) {
            if (StorageManager.isFavorite(day, lang, index)) {
                StorageManager.removeFavorite(day, lang, index);
            } else {
                StorageManager.addFavorite(day, lang, index);
            }
            updateTabCounts();
            // í˜„ì¬ íƒ­ì´ ì¦ê²¨ì°¾ê¸°ë©´ ë‹¤ì‹œ ë Œë”ë§
            if (currentTab === 'favorite') {
                setTab('favorite');
            } else {
                // í˜„ì¬ íƒ­ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì¦ê²¨ì°¾ê¸° ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                setTab(currentTab);
            }
        }

        // ì¦ê²¨ì°¾ê¸° ë Œë”ë§
        function renderFavorites() {
            const favorites = StorageManager.getFavorites();

            if (favorites.length === 0) {
                return `
                <div class="flex flex-col h-full justify-center items-center">
                    <i class="fas fa-star text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">ì¦ê²¨ì°¾ê¸°í•œ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-gray-400 text-sm mt-2">ë‹¨ì–´ ì¹´ë“œì˜ ë³„ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>`;
            }

            let html = '';
            const favoriteItems = [];

            // ëª¨ë“  ì¦ê²¨ì°¾ê¸° í•­ëª© ìˆ˜ì§‘
            favorites.forEach(key => {
                const [day, lang, index] = key.split('_');
                const dayNum = parseInt(day);
                const idx = parseInt(index);

                if (DB[dayNum]) {
                    const data = DB[dayNum];
                    let item = null;

                    if (lang === 'th' && data.th && data.th[idx]) {
                        item = { ...data.th[idx], day: dayNum, lang: 'th', index: idx };
                    } else if (lang === 'en' && data.en && data.en[idx]) {
                        item = { ...data.en[idx], day: dayNum, lang: 'en', index: idx };
                    }

                    if (item) {
                        favoriteItems.push(item);
                    }
                }
            });

            // Dayë³„ë¡œ ê·¸ë£¹í™”
            const groupedByDay = {};
            favoriteItems.forEach(item => {
                if (!groupedByDay[item.day]) {
                    groupedByDay[item.day] = [];
                }
                groupedByDay[item.day].push(item);
            });

            // ë Œë”ë§
            Object.keys(groupedByDay).sort((a, b) => parseInt(a) - parseInt(b)).forEach(day => {
                const dayData = DB[parseInt(day)];
                const items = groupedByDay[day];

                html += `
                <div class="mb-6">
                    <div class="bg-blue-50 p-4 rounded-2xl mb-3 border border-blue-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-[#3182f6] text-xs font-bold">DAY ${day}</span>
                                <h3 class="text-base font-bold text-[#333] mt-1">${escapeHtml(dayData.topic)}</h3>
                            </div>
                            <button onclick="openDay(${day})" class="text-[#3182f6] text-sm font-bold hover:underline" aria-label="DAY ${day} ë³´ê¸°">
                                ë³´ê¸° <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3">
                `;

                items.forEach(item => {
                    if (item.lang === 'th') {
                        const escapedT = escapeHtml(item.t);
                        const escapedK = escapeHtml(item.k || '');
                        const escapedM = escapeHtml(item.m || '');
                        html += `
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 card-press cursor-pointer relative" role="button" tabindex="0">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">íƒœêµ­ì–´ #${item.index + 1}</span>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); toggleFavorite(${item.day}, 'th', ${item.index});"
                                        class="p-2 rounded-full hover:bg-gray-100 text-yellow-500"
                                        aria-label="ì¦ê²¨ì°¾ê¸° í•´ì œ">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <i class="fas fa-volume-high text-gray-300 cursor-pointer" onclick="event.stopPropagation(); speak('${escapedT.replace(/'/g, "\\'")}', 'th');" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div onclick="openDay(${item.day}); setTimeout(() => setTab('th'), 100);">
                                <h3 class="text-xl font-bold text-[#333] mb-1 thai-font leading-relaxed">${escapedT}</h3>
                                <p class="text-sm text-[#ef4444] font-bold mb-1">${escapedK}</p>
                                <p class="text-sm text-gray-500">${escapedM}</p>
                            </div>
                        </div>
                        `;
                    } else {
                        const escapedT = escapeHtml(item.t);
                        const escapedM = escapeHtml(item.m || '');
                        html += `
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 card-press cursor-pointer relative" role="button" tabindex="0">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">ì˜ì–´ #${item.index + 1}</span>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); toggleFavorite(${item.day}, 'en', ${item.index});"
                                        class="p-2 rounded-full hover:bg-gray-100 text-yellow-500"
                                        aria-label="ì¦ê²¨ì°¾ê¸° í•´ì œ">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <i class="fas fa-volume-high text-gray-300 cursor-pointer" onclick="event.stopPropagation(); speak('${escapedT.replace(/'/g, "\\'")}', 'en');" aria-hidden="true"></i>
                                </div>
                            </div>
                            <div onclick="openDay(${item.day}); setTimeout(() => setTab('en'), 100);">
                                <h3 class="text-lg font-bold text-[#333] mb-2 italic serif">"${escapedT}"</h3>
                                <p class="text-sm text-gray-500 font-medium">${escapedM}</p>
                            </div>
                        </div>
                        `;
                    }
                });

                html += `</div></div>`;
            });

            return html;
        }

        function goBack() {
            const detailView = document.getElementById('view-detail');
            detailView.classList.remove('flex');
            detailView.classList.add('hidden');
            const listView = document.getElementById('view-list');
            listView.classList.remove('hidden');
            // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
            setTimeout(() => {
                listView.style.animation = 'none';
                setTimeout(() => {
                    listView.style.animation = '';
                }, 10);
            }, 0);

            // TTS ì¤‘ì§€
            if (window.speechSynthesis) {
            window.speechSynthesis.cancel();
            }

            // íˆìŠ¤í† ë¦¬ ê´€ë¦¬
            if (window.history && window.history.pushState) {
                window.history.pushState(null, null, window.location.pathname);
            }
        }

        function setTab(tab) {
            // ë°ì´í„° ê²€ì¦
            const data = DB[currentDay];
            if (!data) {
                console.error(`Day ${currentDay} ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
            const area = document.getElementById('content-area');
            if (currentTab && scrollPositions[currentTab] !== undefined) {
                scrollPositions[currentTab] = area.scrollTop;
            }

            currentTab = tab;
            quizAnswered = false; // í€´ì¦ˆ ìƒíƒœ ì´ˆê¸°í™”

            // Button Styles
            ['th', 'en', 'favorite', 'quiz'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if (btn) {
                if (t === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                        btn.setAttribute('aria-selected', 'true');
                        btn.setAttribute('tabindex', '0');
                    } else {
                        btn.classList.add('tab-inactive');
                        btn.classList.remove('tab-active');
                        btn.setAttribute('aria-selected', 'false');
                        btn.setAttribute('tabindex', '-1');
                    }
                }
            });

            let html = '';

            if (tab === 'th' && data.th) {
                data.th.forEach((item, i) => {
                    if (!item || !item.t) return; // ë¹ˆ ë°ì´í„° ìŠ¤í‚µ
                    const escapedT = escapeHtml(item.t);
                    const escapedK = escapeHtml(item.k || '');
                    const escapedM = escapeHtml(item.m || '');
                    const isFav = StorageManager.isFavorite(currentDay, 'th', i);
                    html += `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 card-press cursor-pointer relative" role="button" tabindex="0" aria-label="íƒœêµ­ì–´ í‘œí˜„ ${i + 1}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">#${i + 1}</span>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); toggleFavorite(${currentDay}, 'th', ${i});"
                                    class="p-2 rounded-full hover:bg-gray-100 ${isFav ? 'text-yellow-500' : 'text-gray-300'}"
                                    aria-label="${isFav ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€'}">
                                    <i class="fas fa-star ${isFav ? 'fas' : 'far'}"></i>
                                </button>
                                <i class="fas fa-volume-high text-gray-300 cursor-pointer" onclick="event.stopPropagation(); speak('${escapedT.replace(/'/g, "\\'")}', 'th');" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div onclick="speak('${escapedT.replace(/'/g, "\\'")}', 'th')">
                            <h3 class="text-xl font-bold text-[#333] mb-1 thai-font leading-relaxed">${escapedT}</h3>
                            <p class="text-sm text-[#ef4444] font-bold mb-1">${escapedK}</p>
                            <p class="text-sm text-gray-500">${escapedM}</p>
                        </div>
                    </div>`;
                });
            } else if (tab === 'en' && data.en) {
                data.en.forEach((item, i) => {
                    if (!item || !item.t) return; // ë¹ˆ ë°ì´í„° ìŠ¤í‚µ
                    const escapedT = escapeHtml(item.t);
                    const escapedM = escapeHtml(item.m || '');
                    const isFav = StorageManager.isFavorite(currentDay, 'en', i);
                    html += `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 card-press cursor-pointer relative" role="button" tabindex="0" aria-label="ì˜ì–´ í‘œí˜„ ${i + 1}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">#${i + 1}</span>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); toggleFavorite(${currentDay}, 'en', ${i});"
                                    class="p-2 rounded-full hover:bg-gray-100 ${isFav ? 'text-yellow-500' : 'text-gray-300'}"
                                    aria-label="${isFav ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€'}">
                                    <i class="fas fa-star ${isFav ? 'fas' : 'far'}"></i>
                                </button>
                                <i class="fas fa-volume-high text-gray-300 cursor-pointer" onclick="event.stopPropagation(); speak('${escapedT.replace(/'/g, "\\'")}', 'en');" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div onclick="speak('${escapedT.replace(/'/g, "\\'")}', 'en')">
                            <h3 class="text-lg font-bold text-[#333] mb-2 italic serif">"${escapedT}"</h3>
                            <p class="text-sm text-gray-500 font-medium">${escapedM}</p>
                        </div>
                    </div>`;
                });
            } else if (tab === 'favorite') {
                html = renderFavorites();
            } else if (tab === 'quiz') {
                html = renderQuiz(data);
            }

            area.innerHTML = html;

            // ì €ì¥ëœ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
            if (scrollPositions[tab] !== undefined) {
                setTimeout(() => {
                    area.scrollTop = scrollPositions[tab];
                }, 0);
            } else {
                area.scrollTop = 0;
            }
        }

        // --- QUIZ LOGIC (AUTO GENERATOR) ---
        function renderQuiz(data) {
            // ë°ì´í„° ê²€ì¦
            if (!data) {
                return `
                <div class="flex flex-col h-full justify-center items-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">í€´ì¦ˆ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                </div>`;
            }

            // íƒœêµ­ì–´/ì˜ì–´ ë²ˆê°ˆì•„ê°€ë©° ì„ íƒ
            const isThai = quizLangToggle;
            quizLangToggle = !quizLangToggle; // ë‹¤ìŒ ë¬¸ì œë¥¼ ìœ„í•´ í† ê¸€

            const sourceData = isThai ? data.th : data.en;
            const langName = isThai ? 'íƒœêµ­ì–´' : 'ì˜ì–´';

            if (!sourceData || sourceData.length === 0) {
                return `
                <div class="flex flex-col h-full justify-center items-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">${langName} í€´ì¦ˆ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                </div>`;
            }

            // ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§
            const validItems = sourceData.filter(item => {
                if (!item || !item.m) return false;
                if (isThai) {
                    return item.t && item.k && item.m && item.t !== "(ë°ì´í„° ì¤€ë¹„ì¤‘)";
                } else {
                    return item.t && item.m && item.t !== "(Coming Soon)";
                }
            });

            if (validItems.length === 0) {
                return `
                <div class="flex flex-col h-full justify-center items-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">${langName} í€´ì¦ˆ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                </div>`;
            }

            // ëœë¤ ë¬¸ì œ ì„ íƒ
            const idx = Math.floor(Math.random() * validItems.length);
            const qItem = validItems[idx];

            // í€´ì¦ˆ íƒ€ì… ëœë¤ ì„ íƒ (2ê°€ì§€ íƒ€ì…)
            const quizType = Math.random() < 0.5 ? 1 : 2;
            let questionText = '';
            let correctAnswer = '';
            let options = [];
            let correctIndex = 0;

            if (isThai) {
                // íƒœêµ­ì–´ í€´ì¦ˆ
                if (quizType === 1) {
                    // Type 1: í•œêµ­ì–´ ì˜ë¯¸ â†’ íƒœêµ­ì–´ í•œê¸€ ë°œìŒ(k) ì„ íƒ
                    questionText = `"${escapeHtml(qItem.m)}"ì˜ ${langName} í•œê¸€ ë°œìŒì€?`;
                    correctAnswer = qItem.k;

                    // ì˜¤ë‹µ ìƒì„±
                    const wrongIndices = [];
                    while (wrongIndices.length < 3) {
                        const wrongIdx = Math.floor(Math.random() * validItems.length);
                        if (wrongIdx !== idx && !wrongIndices.includes(wrongIdx) && validItems[wrongIdx].k) {
                            wrongIndices.push(wrongIdx);
                        }
                    }
                    options = [qItem.k, validItems[wrongIndices[0]].k, validItems[wrongIndices[1]].k, validItems[wrongIndices[2]].k];
                } else {
                    // Type 2: íƒœêµ­ì–´ í•œê¸€ ë°œìŒ(k) â†’ í•œêµ­ì–´ ì˜ë¯¸ ì„ íƒ
                    questionText = `"${escapeHtml(qItem.k)}"ì˜ ì˜ë¯¸ëŠ”?`;
                    correctAnswer = qItem.m;

                    // ì˜¤ë‹µ ìƒì„±
                    const wrongIndices = [];
                    while (wrongIndices.length < 3) {
                        const wrongIdx = Math.floor(Math.random() * validItems.length);
                        if (wrongIdx !== idx && !wrongIndices.includes(wrongIdx)) {
                            wrongIndices.push(wrongIdx);
                        }
                    }
                    options = [qItem.m, validItems[wrongIndices[0]].m, validItems[wrongIndices[1]].m, validItems[wrongIndices[2]].m];
                }
            } else {
                // ì˜ì–´ í€´ì¦ˆ
                if (quizType === 1) {
                    // Type 1: í•œêµ­ì–´ ì˜ë¯¸ â†’ ì˜ì–´ ì„ íƒ
                    questionText = `"${escapeHtml(qItem.m)}"ì˜ ${langName} í‘œí˜„ì€?`;
                    correctAnswer = qItem.t;

                    // ì˜¤ë‹µ ìƒì„±
                    const wrongIndices = [];
                    while (wrongIndices.length < 3) {
                        const wrongIdx = Math.floor(Math.random() * validItems.length);
                        if (wrongIdx !== idx && !wrongIndices.includes(wrongIdx)) {
                            wrongIndices.push(wrongIdx);
                        }
                    }
                    options = [qItem.t, validItems[wrongIndices[0]].t, validItems[wrongIndices[1]].t, validItems[wrongIndices[2]].t];
                } else {
                    // Type 2: ì˜ì–´ â†’ í•œêµ­ì–´ ì˜ë¯¸ ì„ íƒ
                    questionText = `"${escapeHtml(qItem.t)}"ì˜ ì˜ë¯¸ëŠ”?`;
                    correctAnswer = qItem.m;

                    // ì˜¤ë‹µ ìƒì„±
                    const wrongIndices = [];
                    while (wrongIndices.length < 3) {
                        const wrongIdx = Math.floor(Math.random() * validItems.length);
                        if (wrongIdx !== idx && !wrongIndices.includes(wrongIdx)) {
                            wrongIndices.push(wrongIdx);
                        }
                    }
                    options = [qItem.m, validItems[wrongIndices[0]].m, validItems[wrongIndices[1]].m, validItems[wrongIndices[2]].m];
                }
            }

            // ì„ íƒì§€ ì„ê¸°
            options.sort(() => Math.random() - 0.5);
            correctIndex = options.indexOf(correctAnswer);
            const escapedOpts = options.map(opt => escapeHtml(opt));

            return `
            <div class="flex flex-col h-full justify-center">
                <div class="text-center mb-8">
                    <i class="fas fa-brain text-4xl text-yellow-400 mb-4" aria-hidden="true"></i>
                    <h2 class="text-xl font-bold mb-2">${langName} í€´ì¦ˆ</h2>
                    <p class="text-gray-400 text-sm">ëœë¤ìœ¼ë¡œ ë¬¸ì œê°€ ìƒì„±ë©ë‹ˆë‹¤</p>
                </div>

                <div class="bg-white border border-blue-100 p-8 rounded-2xl text-center shadow-sm mb-6">
                    <p class="text-sm text-gray-500 mb-2">${questionText}</p>
                    ${isThai && quizType === 2 ? `<h3 class="text-2xl font-bold text-[#3182f6] mb-2">${escapeHtml(qItem.k)}</h3>` : ''}
                    ${!isThai && quizType === 2 ? `<h3 class="text-xl font-bold text-[#3182f6] mb-2 italic">"${escapeHtml(qItem.t)}"</h3>` : ''}
                </div>

                <div class="space-y-3" id="quiz-options">
                    ${escapedOpts.map((opt, i) => `
                        <button onclick="checkAns(this, ${i === correctIndex}, ${correctIndex})"
                                class="quiz-option w-full p-4 bg-white border border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-gray-50 transition-colors text-left"
                                role="button"
                                aria-label="ì„ íƒì§€ ${i + 1}: ${opt}">
                            ${opt}
                        </button>
                    `).join('')}
                </div>
                <div class="mt-8 text-center">
                     <button onclick="setTab('quiz')" class="text-sm text-gray-400 underline hover:text-gray-600" aria-label="ë‹¤ìŒ ë¬¸ì œ">ë‹¤ìŒ ë¬¸ì œ (ìƒˆë¡œê³ ì¹¨)</button>
                </div>
            </div>`;
        }

        function checkAns(btn, isCorrect, correctIndex) {
            // ì´ë¯¸ ì •ë‹µì„ ë§ì¶˜ ê²½ìš° ë¬´ì‹œ
            if (quizAnswered) {
                return;
            }

            const options = document.querySelectorAll('.quiz-option');

            if (isCorrect) {
                // ì •ë‹µ ì²˜ë¦¬
                quizAnswered = true;

                // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
                options.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                    opt.disabled = true;
                });

                btn.style.backgroundColor = '#dbeafe'; // Blue-100
                btn.style.borderColor = '#3b82f6';
                btn.style.color = '#1d4ed8';
                btn.innerHTML += ' <i class="fas fa-check float-right mt-1" aria-hidden="true"></i>';
                btn.setAttribute('aria-label', btn.getAttribute('aria-label') + ' - ì •ë‹µ');

                // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
                const existingMessage = document.querySelector('.quiz-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // ì •ë‹µ ë©”ì‹œì§€ í‘œì‹œ
                const quizContainer = document.querySelector('.flex.flex-col.h-full.justify-center');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'quiz-message text-center mt-4';
                messageDiv.innerHTML = '<p class="text-green-600 font-bold text-lg animate-pulse">âœ“ ì •ë‹µì…ë‹ˆë‹¤!</p>';
                quizContainer.querySelector('.space-y-3').after(messageDiv);

                // 1.5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                setTimeout(() => {
                    setTab('quiz');
                }, 1500);
            } else {
                // ì˜¤ë‹µ ì²˜ë¦¬ - ì˜¤ë‹µ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”í•˜ê³  ë‹¤ë¥¸ ì„ íƒì§€ëŠ” ê³„ì† ì„ íƒ ê°€ëŠ¥
                btn.style.pointerEvents = 'none';
                btn.disabled = true;
                btn.style.backgroundColor = '#fee2e2'; // Red-100
                btn.style.borderColor = '#ef4444';
                btn.style.color = '#b91c1c';

                // ì´ë¯¸ X ì•„ì´ì½˜ì´ ìˆëŠ”ì§€ í™•ì¸
                if (!btn.innerHTML.includes('fa-times')) {
                    btn.innerHTML += ' <i class="fas fa-times float-right mt-1" aria-hidden="true"></i>';
                }
                btn.setAttribute('aria-label', btn.getAttribute('aria-label') + ' - ì˜¤ë‹µ');

                // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
                const existingMessage = document.querySelector('.quiz-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // ì˜¤ë‹µ ë©”ì‹œì§€ í‘œì‹œ
                const quizContainer = document.querySelector('.flex.flex-col.h-full.justify-center');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'quiz-message text-center mt-4';
                messageDiv.innerHTML = '<p class="text-red-600 font-bold text-lg">âœ— í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ë³´ì„¸ìš”!</p>';
                quizContainer.querySelector('.space-y-3').after(messageDiv);
            }
        }

        // --- TTS ENGINE ---
        function speak(text, lang) {
            // TTS ì§€ì› ì—¬ë¶€ í™•ì¸
            if (!window.speechSynthesis) {
                console.warn('ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            try {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.85;
                u.volume = 1.0;
                u.pitch = 1.0;

            if (lang === 'th') {
                u.lang = 'th-TH';
                    const v = voices.find(v => v.lang === 'th-TH' || v.lang.startsWith('th'));
                if (v) u.voice = v;
            } else {
                u.lang = 'en-US';
                    const v = voices.find(v => v.lang === 'en-US' || v.lang.startsWith('en'));
                if (v) u.voice = v;
                }

                // ì—ëŸ¬ í•¸ë“¤ë§
                u.onerror = function (event) {
                    console.error('TTS ì—ëŸ¬:', event.error);
                };

                window.speechSynthesis.speak(u);
            } catch (error) {
                console.error('TTS ì‹¤í–‰ ì¤‘ ì—ëŸ¬:', error);
            }
        }
    </script>
</body>

</html>
